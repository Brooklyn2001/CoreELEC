From ae3e286aec0dd13d8302e6a1a685a2017ad8c082 Mon Sep 17 00:00:00 2001
From: Sam Nazarko <email@samnazarko.co.uk>
Date: Sun, 28 Oct 2018 19:21:32 +0000
Subject: [PATCH] hdmitx: set TMDS clock from monitor

Signed-off-by: Sam Nazarko <email@samnazarko.co.uk>
---
 .../amlogic/hdmi/hdmi_tx_20/hdmi_tx_edid.c    | 37 +++++++++++++++----
 .../amlogic/hdmi/hdmi_tx_20/hdmi_tx_main.c    |  1 -
 2 files changed, 30 insertions(+), 8 deletions(-)

diff --git a/drivers/amlogic/hdmi/hdmi_tx_20/hdmi_tx_edid.c b/drivers/amlogic/hdmi/hdmi_tx_20/hdmi_tx_edid.c
index 1993e602e16..84a585f63c6 100644
--- a/drivers/amlogic/hdmi/hdmi_tx_20/hdmi_tx_edid.c
+++ b/drivers/amlogic/hdmi/hdmi_tx_20/hdmi_tx_edid.c
@@ -155,6 +155,18 @@ static int Edid_find_name_block(unsigned char *data)
 		ret = 1;
 	return ret;
 }
+static int Edid_find_range_block(unsigned char *data)
+{
+	int ret = 0;
+	int i;
+	for (i = 0; i < 3; i++) {
+		if (data[i])
+			return ret;
+	}
+	if (data[3] == 0xfd)
+		ret = 1;
+	return ret;
+}
 
 static void Edid_ReceiverProductNameParse(struct rx_cap *pRxCap,
 	unsigned char *data)
@@ -1402,13 +1414,14 @@ static int hdmitx_edid_block_parse(struct hdmitx_dev *hdmitx_device,
 				pRXCap->IEEEOUI = 0x000c03;
 			else
 				goto case_hf;
-			pRXCap->ColorDeepSupport =
-				(unsigned long)BlockBuf[offset+5];
-			pRXCap->Max_TMDS_Clock1 =
-				(unsigned long)BlockBuf[offset+6];
-			/* clock cannot be less than 75MHz */
-			if (pRXCap->Max_TMDS_Clock1 < 15)
-				pRXCap->Max_TMDS_Clock1 = 15;
+			if (count > 5){
+				pRXCap->ColorDeepSupport =
+					(unsigned long)BlockBuf[offset+5];
+				pRXCap->Max_TMDS_Clock1 =
+					(unsigned long)BlockBuf[offset+6];
+			}
+			else
+				pRXCap->Max_TMDS_Clock1 = 0;
 			if (count > 7) {
 				tmp = BlockBuf[offset+7];
 				idx = offset + 8;
@@ -1832,6 +1845,7 @@ int hdmitx_edid_parse(struct hdmitx_dev *hdmitx_device)
 	unsigned char BlockCount;
 	unsigned char *EDID_buf;
 	int i, j, ret_val;
+	int maxPixelClock = 0;
 	int idx[4];
 	struct rx_cap *pRXCap = &(hdmitx_device->RXCap);
 	struct vinfo_s *info = NULL;
@@ -1881,6 +1895,9 @@ int hdmitx_edid_parse(struct hdmitx_dev *hdmitx_device)
 		if (Edid_find_name_block(&EDID_buf[idx[i]]))
 			Edid_ReceiverProductNameParse(&hdmitx_device->RXCap,
 				&EDID_buf[idx[i]+5]);
+
+		if (Edid_find_range_block(&EDID_buf[idx[i]]))
+			maxPixelClock = EDID_buf[idx[i+9]];
 	}
 
 	Edid_ManufactureDateParse(&hdmitx_device->RXCap, &EDID_buf[16]);
@@ -2049,6 +2066,12 @@ int hdmitx_edid_parse(struct hdmitx_dev *hdmitx_device)
 				info->hdr_info.hdr_support);
 		}
 	}
+
+	if (pRXCap->Max_TMDS_Clock1 < 15){
+		hdmi_print(IMP, EDID "Setting maxTMDSclock from range block\n");
+		pRXCap->Max_TMDS_Clock1 = maxPixelClock * 2;
+	}
+
 	return 0;
 
 }
diff --git a/drivers/amlogic/hdmi/hdmi_tx_20/hdmi_tx_main.c b/drivers/amlogic/hdmi/hdmi_tx_20/hdmi_tx_main.c
index c90d88c073a..2f6a5ce0a6e 100644
--- a/drivers/amlogic/hdmi/hdmi_tx_20/hdmi_tx_main.c
+++ b/drivers/amlogic/hdmi/hdmi_tx_20/hdmi_tx_main.c
@@ -1440,7 +1440,6 @@ static ssize_t show_disp_cap(struct device *dev,
 				/* sanity check */
 				para = hdmi_get_fmt_paras(vic);
 				if (! hdmitx_device.RXCap.HF_IEEEOUI &&
-						hdmitx_device.RXCap.Max_TMDS_Clock1 >= 15 &&
 						para->tmds_clk > hdmitx_device.RXCap.Max_TMDS_Clock1 * 5000){
 					pr_info("Mode %s (VIC %d) needs %dMHz clock, more than %dMHz",
 							disp_mode_t[i], vic, para->tmds_clk / 1000, hdmitx_device.RXCap.Max_TMDS_Clock1 * 5);
